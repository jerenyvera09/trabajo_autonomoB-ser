services:
  api-gateway:
    build:
      context: ./sistema_de_informes/services/api-gateway
    container_name: api-gateway
    environment:
      - REST_API_URL=http://rest-api:8000
      - AUTH_SERVICE_URL=http://auth-service:8001
      - PAYMENT_SERVICE_URL=http://payment-service:8002
      - AI_ORCHESTRATOR_URL=http://ai-orchestrator:8003
      - GRAPHQL_URL=http://graphql:4000
      - WS_URL=ws://ws:8080/ws
    ports:
      - "9000:9000"
    networks:
      - informes_net

  graphql:
    build:
      context: ./sistema_de_informes/services/graphql
    container_name: graphql
    environment:
      - REST_BASE_URL=http://rest-api:8000
      - GRAPHQL_REQUIRE_AUTH=1
      - AUTH_SERVICE_URL=http://auth-service:8001
      - JWT_SECRET=${JWT_SECRET:-please-change-this-secret}
      - JWT_ALG=${JWT_ALG:-HS256}
      - REVOKED_SYNC_SECONDS=30
    ports:
      - "4000:4000"
    networks:
      - informes_net

  rest-api:
    build:
      context: ./sistema_de_informes/services/rest-api
    container_name: rest-api
    environment:
      - ALLOW_ORIGINS=*
      - DATABASE_URL=sqlite:////app/app.db
      - WS_BASE_URL=http://ws:8080
      - INTERNAL_WEBHOOK_TOKEN=${INTERNAL_WEBHOOK_TOKEN:-dev-internal-token-change-me}
      - AUTH_SERVICE_URL=http://auth-service:8001
      - JWT_SECRET=${JWT_SECRET:-please-change-this-secret}
      - JWT_ALG=${JWT_ALG:-HS256}
      - SMTP_HOST=mailhog
      - SMTP_PORT=1025
      - SMTP_FROM=${SMTP_FROM:-noreply@local.test}
    ports:
      - "8000:8000"
    networks:
      - informes_net

  auth-db:
    image: postgres:15
    container_name: auth-db
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: auth_pass
    ports:
      - "5433:5432"
    volumes:
      - auth_db_data:/var/lib/postgresql/data
    networks:
      - informes_net

  auth-service:
    build:
      context: ./sistema_de_informes/services/auth-service
    container_name: auth-service
    environment:
      AUTH_DATABASE_URL: postgresql://auth_user:auth_pass@auth-db:5432/auth_db
      JWT_SECRET: ${JWT_SECRET:-please-change-this-secret}
      JWT_ALG: ${JWT_ALG:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: 15
      REFRESH_TOKEN_EXPIRE_MINUTES: 10080
      RATE_LIMIT_LOGIN_ATTEMPTS: 5
      RATE_LIMIT_WINDOW_SECONDS: 60
    depends_on:
      - auth-db
    ports:
      - "8001:8001"
    networks:
      - informes_net

  n8n:
    image: n8nio/n8n:1.70.0
    container_name: n8n
    ports:
      - "5679:5678"
    environment:
      N8N_HOST: localhost
      N8N_PORT: 5678
      N8N_PROTOCOL: http
      # En local usamos HTTP; si la cookie se marca como Secure el navegador no la guarda y el login falla.
      N8N_SECURE_COOKIE: "false"
      INTERNAL_WEBHOOK_TOKEN: ${INTERNAL_WEBHOOK_TOKEN:-dev-internal-token-change-me}
      PARTNER_SHARED_SECRET: ${PARTNER_SHARED_SECRET:-dev-partner-secret-change-me}
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - informes_net

  ws:
    build:
      context: ./sistema_de_informes/services/ws
    container_name: ws
    ports:
      - "8080:8080"
    environment:
      - WS_REQUIRE_AUTH=1
      - WS_JWT_SECRET=${JWT_SECRET:-please-change-this-secret}
      - AUTH_SERVICE_URL=http://auth-service:8001
      - REVOKED_SYNC_SECONDS=30
    networks:
      - informes_net

  frontend:
    build:
      context: ./sistema_de_informes/apps/frontend
    container_name: frontend
    environment:
      - VITE_API_REST=http://localhost:9000
      - VITE_API_GRAPHQL=http://localhost:9000/graphql
      - VITE_API_PAYMENT=http://localhost:9000
      - VITE_AI_ORCHESTRATOR=http://localhost:9000/ai
      - VITE_WS_URL=ws://localhost:9000/ws?room=reports
    ports:
      - "3000:3000"
    networks:
      - informes_net

  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: mailhog
    ports:
      - "8025:8025"
      - "1025:1025"
    networks:
      - informes_net

  payment-service:
    build:
      context: ./sistema_de_informes/services/payment-service
    container_name: payment-service
    environment:
      PAYMENT_PROVIDER: ${PAYMENT_PROVIDER:-mock}
      PAYMENT_SERVICE_SECRET_FALLBACK: ${PAYMENT_SERVICE_SECRET_FALLBACK:-dev-secret-change-me}
      HMAC_HEADER_SIGNATURE: ${HMAC_HEADER_SIGNATURE:-X-Signature}
      HMAC_HEADER_PARTNER_ID: ${HMAC_HEADER_PARTNER_ID:-X-Partner-Id}
    ports:
      - "8002:8002"
    networks:
      - informes_net

  ai-orchestrator:
    build:
      context: ./sistema_de_informes/services/ai-orchestrator
    container_name: ai-orchestrator
    environment:
      LLM_PROVIDER: ${LLM_PROVIDER:-mock}
      ALLOW_ORIGINS: ${AI_ALLOW_ORIGINS:-*}
    ports:
      - "8003:8003"
    networks:
      - informes_net

  partner-php:
    build:
      context: ./backend_php
    container_name: partner-php
    environment:
      PARTNER_SHARED_SECRET: ${PARTNER_SHARED_SECRET:-dev-partner-secret-change-me}
      PARTNER_ID: ${PARTNER_ID:-partner_php_demo}
      TARGET_URL: ${TARGET_URL:-http://payment-service:8002/webhooks/partner}
    ports:
      - "8088:80"
    networks:
      - informes_net

volumes:
  auth_db_data:
  n8n_data:


networks:
  informes_net:
    driver: bridge
